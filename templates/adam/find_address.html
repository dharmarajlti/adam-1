{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static "calc/css/style.css" %}">
  <style>
    .calculation-box {
      height: 93px;
      width: 150px;
      position: absolute;
      bottom: 72px;
      left: 40px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 15px;
      text-align: center;
    }

    p {
      font-family: 'Open Sans';
      margin: 0;
      font-size: 13px;
    }

    #yourLabelId {
    border: 1px solid;
    border-collapse: collapse;
}
.custom-style th {
       font-size: 14px !important;
    }


.custom-style td {
       font-size: 14px !important;
    white-space: break-spaces;
    border-right: 1px solid;
    }
    .submitbtn {
        width:120px;    float: right; padding: 7px;
    }
    .table tbody>tr>td {
      border-top:0px solid;
    }

    table {
      table-layout: inherit !important;
    }
    .mapboxgl-ctrl button{
      background-color : #f9fafb!important
    }
    .mapboxgl-popup-content {
        min-width:200px;
    }

    .my-legend .legend-title {
    text-align: left;
    margin-bottom: 5px;
    font-weight: bold;
    font-size: 90%;
    }
  .my-legend .legend-scale ul {
    margin: 0;
    margin-bottom: 5px;
    padding: 0;
    float: left;
    list-style: none;
    }
  .my-legend .legend-scale ul li {
    font-size: 80%;
    list-style: none;
    margin-left: 0;
    line-height: 18px;
    margin-bottom: 2px;
    }
  .my-legend ul.legend-labels li span {
    display: block;
    float: left;
    height: 16px;
    width: 30px;
    margin-right: 5px;
    margin-left: 0;
    border: 1px solid #999;
    }

     .adam_style  .table thead > tr > th {
      background: #d92632 !important;
    }
    .adam_style .table tbody > tr > td {
      background: #fff !important;
      color: #000 !important;
    border-bottom: 1px solid #ccc;
    }
    /* .adam_style .table tr{
      border: 1px solid;
    } */
    .adam_style table.dataTable thead th, table.dataTable thead td {
      border-bottom: none;
    }
    .adam_style .table, .adam_style .table thead th {
      border-spacing: 0;
      border-width:1px;
    }
    .adam_style .table tbody > tr > td:last-child
     { border-right: 1px solid #ccc; }
     .adam_style .table tbody > tr > td a  {
      border-right: 1px solid #ccc;
     }
     .adam_style .table tbody > tr > td a {
       color: #000;
     }
     .adam_style #rateAnalysis_wrapper #rateAnalysis_paginate .paginate_button.disabled
        {
       background: #54b4f0;
     }
     .adam_style #rateAnalysis_wrapper #rateAnalysis_paginate .paginate_button
     {
      background: #54b4f0;
     }
  </style>
<section class="main-container">
  <div class="container">
    <header class="blog-header py-3">
      <div class="row flex-nowrap justify-content-between align-items-center">
        <div class="col-4 pt-1">

        </div>
        <div class="col-4 text-center">
          <a class="blog-header-logo text-dark text-decoration-none" href="#"> SEARCH PANEL </a>
        </div>
        <div class="col-4 d-flex justify-content-end align-items-center">

        </div>
      </div>
    </header>


  </div>
  <main class="container">
      <div class="row">
    <div class="col-md-9">
      <div class="pt-3">
      <div id="map" class="map mb-3" style='height: 500px; margin:0 auto;'></div>
      <div class="calculation-box" style="display:none">
        <p>Click the map to draw a polygon.</p>
        <div id="calculated-area"></div>
      </div>

    <div class="container-md my-4">
		<div class="rateAnalysisContainer bg-white adam_style" style="display:none">
		  <div class="table-responsive">
			<table class="table" id="rateAnalysis">
				<thead>
					<tr>
					    <th scope="col">Panel No</th>
                        <th scope="col">Player No</th>
						<th scope="col">Co ordinates</th>
						<th scope="col">City </th>
						<th scope="col">Market</th>
						<th scope="col">Media Type</th>
					</tr>
				</thead>
				<tbody>

				</tbody>
				<tfoot>
				</tfoot>
			</table>
		  </div>
		</div>
    </div>

      <table id="yourLabelId" class="table table-bordered" style="display:none">
        <thead>
          <tr>
            <th> Co ordinates</th>
            <th> Locations</th>
          </tr>
        </thead>
        <tbody>

        </tbody>
      </table>
        <button type="button" class="btn btn-primary submitbtn" style="display:block;">Reset</button>
      </div>
    </div>

    <div class="col-md-3">
        <div class='my-legend'>
        <div class='legend-title'>Panel Media Type</div>
        <div class='legend-scale'>
          <ul class='legend-labels'>
            <li><span style='background:#fcb103;'></span>Bulletin</li>
            <li><span style='background:#ebfc03;'></span>Custom Bulletin</li>
            <li><span style='background:#03fcb1;'></span>Jr Poster</li>
            <li><span style='background:#8c8cbf;'></span>Kiosk</li>
            <li><span style='background:#fc03ba;'></span>Managed Digital</li>
            <li><span style='background:#351d6e;'></span>Parking Deck Display</li>
            <li><span style='background:#8c1921;'></span>Poster</li>
          </ul>
        </div>
        </div>
    </div>
      </div>
  </main>
 </section>
<script src="{% static "calc/js/main.js" %}"></script>
<!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"-->
<!--    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="-->
<!--    crossorigin="anonymous" referrerpolicy="no-referrer"></script>-->

  <script>


    mapboxgl.accessToken = 'pk.eyJ1IjoicHJhdmVlbmxrdW1hciIsImEiOiJjbDBncnp6MGcwMHBkM29vMjE2YjB5ZXJ2In0.luURpRwktZMoOvxihp_J_A';
    const map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/mapbox/streets-v11', // style URL
      center: [-101.82219812898614, 40.139548654849946], // starting position [lng, lat]
      zoom: 3 // starting zoom
    });

    map.addControl(
      new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl
      })
    );
    check_lng = []
    check_lat = []
    final_cods = []
    map.on('click', function (e) {
      var eventLngLat = [e.lngLat.lng, e.lngLat.lat];
      check_lng.push(e.lngLat.lng)
      check_lat.push(e.lngLat.lat)
      final_cods.push(eventLngLat)
      //console.log(eventLngLat)
    });

    const draw = new MapboxDraw({
      displayControlsDefault: false,
      // Select which mapbox-gl-draw control buttons to add to the map.
      controls: {
        polygon: true,
        trash: true
      },
      // Set mapbox-gl-draw to draw by default.
      // The user does not have to click the polygon control button first.
      defaultMode: 'draw_polygon'
    });
    map.addControl(draw);

    map.on('draw.create', updateArea);
    map.on('draw.delete', updateArea);
    map.on('draw.update', updateArea);
    map.addControl(new mapboxgl.NavigationControl());
    function updateArea(e) {
      const data = draw.getAll();
      //console.log(draw)
      const answer = document.getElementById('calculated-area');
      if (data.features.length > 0) {
        const area = turf.area(data);
        //console.log(turf)
        console.log(check_lng)
        max_lng=Math.max.apply(Math,check_lng)
        min_lng=Math.min.apply(Math,check_lng)
        max_lat=Math.max.apply(Math,check_lat)
        min_lat=Math.max.apply(Math,check_lat)
        check_area_details(max_lng,min_lng,max_lat,min_lat)
        var lngLatArray = data.features[0].geometry.coordinates[0]
        // Restrict the area to 2 decimal points.
        const rounded_area = Math.round(area * 100) / 100;


        answer.innerHTML = `<p><strong>${rounded_area}</strong></p><p>square meters</p>`;
      } else {
        answer.innerHTML = '';
        if (e.type !== 'draw.delete')
          alert('Click the map to draw a polygon.');
      }
    }
    function makeRadius(lngLatArray, radiusInMeters) {
      var point = turf.point(lngLatArray);
      //console.log(point)
      var buffered = turf.buffer(point, radiusInMeters, { units: 'meters' });
      return buffered;
    }

    function uniqueArray2(arr) {
        var a = [];
        for (var i=0, l=arr.length; i<l; i++)
            if (a.indexOf(arr[i]) === -1 && arr[i] !== '')
                a.push(arr[i]);
        return a;
    }
    function check_area_details(max_lng,min_lng,max_lat,min_lat){
        cods = uniqueArray2(final_cods)
        new_cods = []
        $.each(cods, function(i,val){
            console.log(val[0])
            console.log(val[1])
            new_cods.push('(' +val[0]+ "," +val[1]+ ')')
        })
        console.log(new_cods)
        data = {"min_lng":min_lng,"max_lng":max_lng, "min_lat":min_lat,
                "max_lat":max_lat,"cods":JSON.stringify(cods),"length":cods.length}
        $.ajax({
            type:"POST",
            async: false,
            url: "/check_area/",
            data: data,
            dataType: 'json',
            success: function(res){
                //console.log(res)
                data = res['data']
                count = res['count']
                console.log(count)
                if(count > 0){
                    //console.log(data.length)
                    //$("#yourLabelId").show()
                    $(".rateAnalysisContainer").show()
                    $(".dataTables_empty").remove()
                    color_array = {
                        "Bulletin":"#fcb103",
                        "Custom Bulletin":"#ebfc03",
                        "Jr Poster":"#03fcb1",
                        "Kiosk":"#8c8cbf",
                        "Managed Digital":"#fc03ba",
                        "Parking Deck Display":"#351d6e",
                        "Poster":"#8c1921"
                    }
                    html = ''
                    html1 = ''
                    $.each(data, function(i,v){
                        //console.log(v['longitude'])
                        //console.log(v['latitude'])
                      latlng = v['longitude'] +","+v['latitude']
                      panel = v['panel_no']
                      player = v['player_no']
                      city = v['city']
                      market = v['market_name']
                      mediatype = v['media_type']
                      if(color_array[mediatype]){
                         color = color_array[mediatype]
                      }else{
                        color = "#198754"
                      }
                      const marker1 = new mapboxgl.Marker({ "color": color })
                      .setLngLat([v['longitude'], v['latitude']])
                      .setPopup(new mapboxgl.Popup().setHTML('<div><p>'+latlng+'</p><p>'+city+'</p><p>'+panel+'</p><p>'+market+'</p><p>'+mediatype+'</p></div>'))
                      .addTo(map);
                      //marker1.togglePopup();

                      //address = 'v['city'] +","+ v['state'] +","+ v['country']'
                      address = 'N. Charleston'
                      html += '<tr><td>'+latlng+'</td><td>'+address+'</td></tr>'
                      html1 += '<tr><td>'+panel+'</td><td>'+player+'</td><td>'+latlng+'</td><td>'+city+'</td><td>'+market+'</td><td>'+mediatype+'</td></tr>'

                    })
                    //$("#yourLabelId tbody").append(html)
                    $("#rateAnalysis tbody").append(html1)
                }else{
                    alert("Panel Not available in the Polygon Area")
                }
            }
        })

    }

    $(".submitbtn").click(function(){
      location.reload();
    })
  </script>

{% endblock %}